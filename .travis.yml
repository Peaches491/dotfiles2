---
# Travis CI support provided by: https://github.com/jonashackt/vagrant-travisci-libvrt
#   ...and viewers like you!

dist: bionic
language: python

# Cache the big Vagrant boxes
cache:
  directories:
  - /home/travis/.vagrant.d/boxes

# Download vagrant and verify SHA
before_install:
- |
  curl -Os https://releases.hashicorp.com/vagrant/2.2.7/vagrant_2.2.7_x86_64.deb
  curl -Os https://releases.hashicorp.com/vagrant/2.2.7/vagrant_2.2.7_SHA256SUMS
  curl -Os https://releases.hashicorp.com/vagrant/2.2.7/vagrant_2.2.7_SHA256SUMS.sig
  gpg --receive-key 51852D87348FFC4C
  gpg --verify vagrant_2.2.7_SHA256SUMS.sig vagrant_2.2.7_SHA256SUMS
  sha256sum -c vagrant_2.2.7_SHA256SUMS 2>&1 | grep OK

# Install libvrt & KVM (see https://github.com/alvistack/ansible-role-virtualbox/blob/master/.travis.yml)
install:
- |
  sudo apt-get update
  sudo apt-get install -y bridge-utils dnsmasq-base ebtables libvirt-bin libvirt-dev qemu-kvm qemu-utils ruby-dev
- sudo dpkg -i vagrant_2.2.7_x86_64.deb
- vagrant --version
- sudo vagrant plugin install vagrant-libvirt

# For testing 'libvirt' locally on OSX (Mojave):
# https://github.com/vagrant-libvirt/vagrant-libvirt/issues/497#issuecomment-597564837
script:
- |
  set -euo pipefail
  export DOTFILES_PLATFORM=ubuntu
  sudo ./vagrant.sh up --no-provision
  travis_wait 30 sudo ./vagrant.sh provision
